<html>

<head>

    <!-- <script type="text/javascript" src="static/js/sdk/star_rtc_video.min.js"></script> -->
    <!-- <script type="text/javascript" src="static/js/sdk/star_rtc_lib.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script type="text/javascript" src="static/js/jquery-3.2.1.min.js"></script>
</head>

<body>
    <div id="app">
        <P> {{ message }} </P>
        <button v-on:click="getDevcices">get devices</button>    
        <button v-on:click="setVideo">set video</button>
        <button v-on:click="connect">connect</button>
        <div v-for="(device, index) in devices">{{device.kind + ": " + device.label +" id = " + device.deviceId}}</div>
        <video v-show="videoDisplay" id="video">Video stream not available.</video>
        <div>
            <span>用户名：</span>
            <input type="text" v-model="userName">
            <button v-on:click="signin">sign in</button>
            <span v-show="logincondition">{{userName + ":注册成功" }}</span>
        </div>
        <div>
            <button v-on:click="getUserList">userList</button>
            <div v-for="item in userList">{{item}}</div>
        </div>
        <div>
            <span>发起呼叫：</span>
            <input type="text" v-model="callee">
            <button v-on:click="call">call </button>
        </div>
        
    </div>

    <script>
        

        var app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                videoDisplay: false,
                devices: [],
                wss :undefined,
                userName:undefined,
                logincondition:false,
                callee:undefined,
                userList:[],
            },
            methods: {
                getDevcices: function () {
                    console.log("getDevcices clicked");
                    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                        console.log("不支持 enumerateDevices() .");
                        return;
                    }
                    navigator.mediaDevices.enumerateDevices()
                        .then(function (devices) {
                            console.log(this);
                            app.devices = devices;
                            devices.forEach(function (device) {
                                console.log(device.kind + ": " + device.label + " id = " + device.deviceId);
                            })
                        })
                        .catch(function (err) {
                            console.log(err.name + ": " + err.message);
                        })
                },
                setVideo: function () {
                    
                    var servers = null;
                    var constraints = window.constraints = {
                        audio: false,
                        video: true
                    };
                    var video = document.querySelector('video');
                    console.log(video);
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(function (mediaStream) {
                            var video = document.querySelector('video');
                            video.srcObject = mediaStream;
                            video.onloadedmetadata = function (e) {
                                video.play();
                            };
                            app.videoDisplay=true;
                        })
                        .catch(function(err) { 
                            console.log(err.name + ": " + err.message); 
                        });

                },
                //next function
                call:function(){
                    console.log("call click");
                    var pc =new RTCPeerConnection();
                    var constraints = window.constraints = {
                        audio: false,
                        video: true
                    };
                    pc.onaddstream =function (evt){
                        console.log("onaddstream");
                        console.log(evt);
                    };
                    navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream){
                        pc.createOffer().then(function(offer){
                            console.log("create offer");
                            console.log(offer);
                            return pc.setLocalDescription(offer);
                        })
                        .then(function(){
                            var offerInfo=({
                                    fromID: app.userName,
                                    targetID: app.callee,
                                    type: "video-offer",
                                    localDescription: pc.localDescription // offer
                                });
                            console.log(offerInfo);
                            var message ={
                                type:"video-offer",
                                formID:app.userName,
                                data:offerInfo
                            };
                            app.wss.send(JSON.stringify(message));
                          
                        })
                        .catch(function(reason){
                            console.log(reason)
                        });
                    })
                    .catch(function(err){
                        console.log(err);
                    })
                },
                //next function
                connect:function(){
                    if( !"WebSocket" in window){
                        console.log("浏览器不支持 websocket");
                        return;
                    }
                    app.wss=new WebSocket("wss://192.168.8.100:8000")
                    app.wss.onopen =function(e){
                        console.log("onopen");
                    };
                    app.wss.onmessage =function(e){
                        console.log("onmessage ");
                        console.log(e);
                        var data= JSON.parse (e.data);
                        console.log(data.type);
                        if(data.type=="signin"){
                            console.log("signin success");
                            app.logincondition=true;
                        }
                        if(data.type=="getUsers"){
                            console.log("getUsers success");
                            app.userList=data.data;

                        }
                    };
                    app.wss.onclose =function(e){
                        console.log("onclose ");
                    }

                },
                //next function
                signin:function(){
                    if(app.wss==undefined){
                        console.log("websocket 未连接");
                        return;
                    }
                    if(app.userName==undefined){
                        console.log("用户名为设置");
                        return;
                    }
                    var message={
                        type:"signin",
                        formID:app.userName
                    };
                    app.wss.send(JSON.stringify(message));
                },
                //next function
                getUserList:function(){
                    if(app.wss==undefined){
                        console.log("websocket 未连接");
                        return;
                    }
                    var message={
                        type:"getUserList",
                        formID:app.userName
                    };
                    app.wss.send(JSON.stringify(message))
                }
                //next function
                
            },
        });

    </script>
</body>

</html>